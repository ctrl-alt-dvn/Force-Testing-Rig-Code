#include <Adafruit_NAU7802.h>

Adafruit_NAU7802 nau;

// Calibration variables
float calibrationFactor = 1.0;  // Scale factor to convert raw readings to force units (Newtons)
int32_t zeroOffset = 0;         // Zero offset (tare value)
bool isCalibrated = false;

void setup() {
  Serial.begin(115200);
  Serial.println("NAU7802 Scale with Calibration");
  if (! nau.begin()) {
    Serial.println("Failed to find NAU7802");
    while (1) delay(10);  // Don't proceed.
  }
  Serial.println("Found NAU7802");

  nau.setLDO(NAU7802_3V0);
  Serial.print("LDO voltage set to ");
  switch (nau.getLDO()) {
    case NAU7802_4V5:  Serial.println("4.5V"); break;
    case NAU7802_4V2:  Serial.println("4.2V"); break;
    case NAU7802_3V9:  Serial.println("3.9V"); break;
    case NAU7802_3V6:  Serial.println("3.6V"); break;
    case NAU7802_3V3:  Serial.println("3.3V"); break;
    case NAU7802_3V0:  Serial.println("3.0V"); break;
    case NAU7802_2V7:  Serial.println("2.7V"); break;
    case NAU7802_2V4:  Serial.println("2.4V"); break;
    case NAU7802_EXTERNAL:  Serial.println("External"); break;
  }

  nau.setGain(NAU7802_GAIN_128);
  Serial.print("Gain set to ");
  switch (nau.getGain()) {
    case NAU7802_GAIN_1:  Serial.println("1x"); break;
    case NAU7802_GAIN_2:  Serial.println("2x"); break;
    case NAU7802_GAIN_4:  Serial.println("4x"); break;
    case NAU7802_GAIN_8:  Serial.println("8x"); break;
    case NAU7802_GAIN_16:  Serial.println("16x"); break;
    case NAU7802_GAIN_32:  Serial.println("32x"); break;
    case NAU7802_GAIN_64:  Serial.println("64x"); break;
    case NAU7802_GAIN_128:  Serial.println("128x"); break;
  }

  nau.setRate(NAU7802_RATE_10SPS);
  Serial.print("Conversion rate set to ");
  switch (nau.getRate()) {
    case NAU7802_RATE_10SPS:  Serial.println("10 SPS"); break;
    case NAU7802_RATE_20SPS:  Serial.println("20 SPS"); break;
    case NAU7802_RATE_40SPS:  Serial.println("40 SPS"); break;
    case NAU7802_RATE_80SPS:  Serial.println("80 SPS"); break;
    case NAU7802_RATE_320SPS:  Serial.println("320 SPS"); break;
  }

  // Take 10 readings to flush out readings
  for (uint8_t i=0; i<10; i++) {
    while (! nau.available()) delay(1);
    nau.read();
  }

  while (! nau.calibrate(NAU7802_CALMOD_INTERNAL)) {
    Serial.println("Failed to calibrate internal offset, retrying!");
    delay(1000);
  }
  Serial.println("Calibrated internal offset");

  while (! nau.calibrate(NAU7802_CALMOD_OFFSET)) {
    Serial.println("Failed to calibrate system offset, retrying!");
    delay(1000);
  }
  Serial.println("Calibrated system offset");
  
  Serial.println("\nCalibration Commands:");
  Serial.println("'t' - Tare (zero) the scale");
  Serial.println("'c' - Calibrate with known weight");
  Serial.println("'r' - Reset calibration");
  Serial.println();
}

void loop() {
  // Check for serial commands
  if (Serial.available()) {
    char command = Serial.read();
    switch (command) {
      case 't':
      case 'T':
        tareScale();
        break;
      case 'c':
      case 'C':
        calibrateWithKnownWeight();
        break;
      case 'r':
      case 'R':
        resetCalibration();
        break;
    }
  }
  
  // Read and display weight
  while (! nau.available()) {
    delay(1);
  }
  int32_t rawValue = nau.read();
  
  if (isCalibrated) {
    float force = getForce(rawValue);
    Serial.print("Force: ");
    Serial.print(force, 4);
    Serial.print(" N");
  } else {
    Serial.print("Raw: ");
    Serial.print(rawValue);
    Serial.print(" (not calibrated)");
  }
  Serial.println();
  
  delay(500);  // Update every 500ms
}

// Function to get average reading over multiple samples
int32_t getAverageReading(int samples = 10) {
  long sum = 0;
  for (int i = 0; i < samples; i++) {
    while (! nau.available()) delay(1);
    sum += nau.read();
  }
  return sum / samples;
}

// Function to tare (zero) the scale
void tareScale() {
  Serial.println("Taring scale... Remove all weight and press Enter");
  while (Serial.available()) Serial.read(); // Clear buffer
  while (!Serial.available()) delay(10);   // Wait for Enter
  while (Serial.available()) Serial.read(); // Clear buffer
  
  Serial.println("Measuring zero point...");
  zeroOffset = getAverageReading(20);
  Serial.print("Tare complete. Zero offset: ");
  Serial.println(zeroOffset);
}

// Function to calibrate with a known weight
void calibrateWithKnownWeight() {
  Serial.println("=== Force Scale Calibration ===");
  
  // Step 1: Tare the scale
  Serial.println("Step 1: Remove all weight from scale and press Enter");
  while (Serial.available()) Serial.read(); // Clear buffer
  while (!Serial.available()) delay(10);   // Wait for Enter
  while (Serial.available()) Serial.read(); // Clear buffer
  
  Serial.println("Measuring zero point...");
  zeroOffset = getAverageReading(20);
  Serial.print("Zero point set: ");
  Serial.println(zeroOffset);
  
  // Step 2: Get known force value
  Serial.println("\nStep 2: Enter the force of your calibration object in Newtons:");
  Serial.println("(e.g., 0.9807 for ~100g object, 4.9033 for ~500g object)");
  Serial.println("Tip: Force (N) = Mass (kg) Ã— 9.80665");
  
  float knownForce = 0;
  while (knownForce <= 0) {
    while (!Serial.available()) delay(10);
    String input = Serial.readString();
    input.trim();
    knownForce = input.toFloat();
    
    if (knownForce <= 0) {
      Serial.println("Please enter a valid positive force in Newtons:");
    }
  }
  
  Serial.print("Calibration force: ");
  Serial.print(knownForce, 4);
  Serial.println(" Newtons");
  
  // Step 3: Measure with known force
  Serial.println("\nStep 3: Place the calibration object on the scale and press Enter");
  while (Serial.available()) Serial.read(); // Clear buffer
  while (!Serial.available()) delay(10);   // Wait for Enter
  while (Serial.available()) Serial.read(); // Clear buffer
  
  Serial.println("Measuring with calibration object...");
  int32_t weightedReading = getAverageReading(20);
  
  // Calculate calibration factor
  int32_t rawForceDifference = weightedReading - zeroOffset;
  
  if (rawForceDifference == 0) {
    Serial.println("Error: No force detected. Calibration failed.");
    return;
  }
  
  calibrationFactor = knownForce / (float)rawForceDifference;
  isCalibrated = true;
  
  Serial.println("\n=== Calibration Complete ===");
  Serial.print("Zero offset: ");
  Serial.println(zeroOffset);
  Serial.print("Raw reading with object: ");
  Serial.println(weightedReading);
  Serial.print("Raw difference: ");
  Serial.println(rawForceDifference);
  Serial.print("Calibration factor: ");
  Serial.println(calibrationFactor, 8);
  Serial.println("Scale is now calibrated for force measurement!");
  Serial.println("Remove the calibration object to begin normal operation.\n");
}

// Function to convert raw reading to force
float getForce(int32_t rawReading) {
  return (rawReading - zeroOffset) * calibrationFactor;
}

// Function to reset calibration
void resetCalibration() {
  calibrationFactor = 1.0;
  zeroOffset = 0;
  isCalibrated = false;
  Serial.println("Calibration reset. Use 'c' command to recalibrate.");
}
